// Top-level build file where you can add configuration options common to all sub-projects/modules.

buildscript {
  // Load local integration mode configuration from properties file
  def props = new Properties()
  def propsFile = new File(rootProject.projectDir, '../../local-integration.properties')
  if (propsFile.exists()) {
    propsFile.withInputStream { props.load(it) }
  }
  ext.enableLocalIntegrationModeAndroid = props.getProperty('enableLocalIntegrationModeAndroid', 'false').toBoolean()
  
  ext {
    // Versions should match our SDK support levels
    buildToolsVersion = "35.0.0"
    minSdkVersion = 24
    compileSdkVersion = 35
    ndkVersion = "27.1.12297006"
    targetSdkVersion = 35
    kotlinVersion = "2.0.21"
  }
  repositories {
    google()
    mavenCentral()
  }

  dependencies {
    classpath("com.android.tools.build:gradle")
    classpath("com.facebook.react:react-native-gradle-plugin")
    classpath("org.jetbrains.kotlin:kotlin-gradle-plugin")
    classpath("com.google.gms:google-services:4.4.1")
    //Required by the native sdk
    classpath 'com.google.firebase:firebase-crashlytics-gradle:2.9.8'
  }

  allprojects {
    repositories {
      if (enableLocalIntegrationModeAndroid) mavenLocal()
      
      google()
      mavenCentral()
      
      maven {
        name = "LucraGithubPackages"
        url = uri("https://maven.pkg.github.com/Lucra-Sports/lucra-android-sdk")
        credentials {
          String gprUser = findProperty('GPR_USER') ?: System.getenv('GPR_USER')
          String gprKey = findProperty('GPR_KEY') ?: System.getenv('GPR_KEY')

          if (!enableLocalIntegrationModeAndroid) {
            if (!gprUser) {
              throw new GradleException("GPR_USER not set in ~ .gradle/gradle.properties, local gradle.properties or as an environment variable.")
            }
            if (!gprKey) {
              throw new GradleException("GPR_KEY not set in ~ .gradle/gradle.properties, local gradle.properties or as an environment variable.")
            }
          }

          username = gprUser
          password = gprKey
        }
      }
      maven {
        url("$rootDir/../node_modules/detox/Detox-android")
      }
      maven {
        url "https://zendesk.jfrog.io/zendesk/repo"
      }
    }
  }

  subprojects {
      afterEvaluate { subproject ->
        if (project.hasProperty('android')) {
              android {
                  packagingOptions {
                      pickFirst '**/libc++_shared.so'
                      pickFirst '**/libfbjni.so'
                      pickFirst '**/libjsc.so'
                      pickFirst '**/libreactnativejni.so'
                      pickFirst '**/libhermes.so'
                      pickFirst '**/libreactnative.so'
                  }
              }
          }
            def String taskRequests = getGradle().getStartParameter().getTaskRequests().toString()
            if (taskRequests.contains("assembleAndroidTest")) {
                android {
                    defaultConfig {
                        manifestPlaceholders = [auth0Domain: "LUCRA_SDK", auth0Scheme: "LUCRA_SDK",
                                   firebaseJsonAutoCollectionEnabled: 'true',
            firebaseJsonCollectionDeactivated: 'false',
            firebaseJsonAdidEnabled: 'true',
            firebaseJsonSsaidEnabled: 'true',
            firebaseJsonAutomaticScreenReportingEnabled: 'true',
            firebaseJsonAnalyticsStorageEnabled: 'true',
            firebaseJsonAdStorageEnabled: 'true',
            firebaseJsonAdUserDataEnabled: 'true',
            firebaseJsonPersonalizationEnabled: 'true',
            firebaseJsonDataCollectionDefaultEnabled: 'true' 
                        ]
                    }
                }
            }
      }
  }
}

apply plugin: "com.facebook.react.rootproject"
